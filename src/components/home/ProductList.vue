<template>
    <div class="product-list">
        <div class="container">
            <div class="product-list__box">
                <div class="product-list__box--item" v-for="(product,index) in searchingProduct" :key="index">
                    <img class="product-list__box--item-img" :src="product.imageUrl" alt="product">
                    <div class="product-list__box--item-like">
                        <img src="../../assets/img/fullheart.svg" alt="fullheart" v-if="product.like" class="heart-svg">
                        <svg v-else @click.prevent="likeProduct(product.title, product.price, product.imageUrl, product.location)" class="heart-svg" width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path class="heart-svg__path" :class="{'like': product.like == true}" fill-rule="evenodd" clip-rule="evenodd" d="M14.468 0.0104926C15.968 0.0104926 17.3937 0.638009
                            18.383 1.61687C19.3723 2.59549 20 4.02098 19.9998 5.52118C19.9998 6.01046 19.9498 6.48981 19.8509 6.95732C19.6523 
                            7.89419 19.4115 8.56141 18.8616 9.40409C18.5925 9.81667 18.3537 10.1614 18.1276 10.4465C17.9068 10.7252 17.5957 
                            11.0636 17.2021 11.4574C16.8084 11.8509 16.4892 12.1593 16.2446 12.3828C16.1231 12.4936 15.9724 12.6247 15.7958 
                            12.7784C15.6164 12.9346 15.4101 13.114 15.1807 13.319C14.4444 13.9763 13.8748 14.4919 13.4785 14.8614C13.0875 
                            15.2261 12.5981 15.7361 12.0103 16.3933C11.4279 17.0446 10.9303 17.7051 10.4997 18.3508C10.3769 18.535 10.202 
                            18.6167 9.99974 18.6167C9.80843 18.6167 9.6466 18.5332 9.52111 18.3508C8.84863 17.3735 8.13827 16.5208 7.1701 
                            15.5956C6.69147 15.138 6.32696 14.7899 6.07438 14.5636C6.02983 14.5237 5.981 14.4798 5.92779 14.4321C5.67275 
                            14.203 5.31713 13.8836 4.85088 13.4785C4.36134 13.0532 3.98912 12.7233 3.74448 12.4997C3.49984 12.2763 3.16484 
                            11.9627 2.7552 11.5635C2.34575 11.1647 2.04255 10.8189 1.82967 10.5422C1.61703 10.2658 1.36853 9.91722 1.09572 
                            9.49987C0.826111 9.08726 0.623431 8.68216 0.489314 8.30837C0.219216 7.55441 0 6.55288 0 5.52115C0 4.02098 0.627745 
                            2.59549 1.61706 1.61683C2.60657 0.638009 4.03206 0.0104599 5.53199 0.0104599C6.41484 0.0104599 7.24458 0.212486 
                            8.04255 0.616898C8.84049 1.02111 9.48938 1.57419 10 2.27637C10.5107 1.57419 11.1595 1.02111 11.9575 0.61693C12.7552 
                            0.212486 13.585 0.0104926 14.468 0.0104926ZM16.8724 10.0849C17.9018 8.94425 18.5185 7.78657 18.7234 6.60618C18.7844 
                            6.25464 18.8192 5.89334 18.8195 5.52115C18.8195 4.31899 18.394 3.29771 17.5429 2.45729C16.6919 1.61687 15.6706 1.19134 
                            14.4684 1.19134C13.628 1.19134 12.8407 1.41464 12.1281 1.87219C11.4154 2.32948 10.9023 2.93977 10.543 3.69121C10.4341 
                            3.91886 10.245 4.02098 10.0004 4.02098C9.75575 4.02098 9.58189 3.91134 9.47908 3.69121C9.12435 2.93252 8.5749 2.32948 
                            7.86206 1.87219C7.14918 1.41464 6.37255 1.19134 5.53216 1.19134C4.33023 1.19134 3.30892 1.6169 2.44719 2.46794C1.59611 
                            3.30837 1.17059 4.32964 1.17059 5.52115C1.17059 6.14866 1.22621 6.71513 1.40458 7.26572L1.64925 8.02102C1.77138 8.39851 
                            2.06814 8.8369 2.30582 9.18803C2.36051 9.26881 2.41206 9.34497 2.45765 9.41471C2.57569 9.59497 2.75565 9.81892 2.98964 
                            10.0743C3.03999 10.1292 3.08824 10.1818 3.13436 10.2321C3.3026 10.4155 3.44259 10.5681 3.55337 10.6913C3.69931 10.8534 
                            3.92265 11.067 4.21291 11.3295L4.8831 11.936L5.61706 12.5848C6.30611 13.194 6.80856 13.6381 7.13833 13.9359C7.4681 14.2339 
                            7.91222 14.6833 8.48938 15.2763C9.06108 15.8641 9.56376 16.436 9.99997 16.9997C10.4149 16.4253 10.9014 15.8375 11.4575 
                            15.2445C12.0185 14.646 12.4894 14.1703 12.8723 13.819C13.2661 13.4575 13.7685 13.0027 14.3936 12.4466C15.5983 11.3749 
                            16.423 10.5826 16.8724 10.0849Z" fill="white"/>
                        </svg>
                    </div>
                    <p class="product-list__box--item-title">{{product.title}}</p>
                    <p class="product-list__box--item-price">${{product.price}}</p>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import firebase from 'firebase/app'
import {bus} from '../../main'

export default {
    name: "ProductList",
    data: () => ({
        products: [],
        searchTitle: '',
        searchLocation: '',
        filterPriceFrom: '0',
        filterPriceTo: '10000000'
    }),
    async mounted() {
        this.getProducts()
        bus.$on('getLikesPosts', this.getLikeProducts)
        bus.$on('putSearch', this.setSearcher)
        bus.$on('putFilter', this.setFilter)
    },
    methods: {
        async getProducts() {
            try {
                const info = (await firebase.database().ref(`/products`).once('value')).val()
                const uid = await this.$store.dispatch('getUid')
                const likeProducts = (await firebase.database().ref(`/users/${uid}/likeProducts`).once('value')).val() || ''
                const likeProductsArr = []
                Object.keys(likeProducts).forEach(key => {
                    likeProductsArr.push({
                        title: likeProducts[key].title,
                        price: likeProducts[key].price,
                        imageUrl: likeProducts[key].imageUrl,
                        location: likeProducts[key].location
                    })
                })
                const products = []
                Object.keys(info).forEach(key => {
                    products.push({
                        title: info[key].title,
                        price: info[key].price,
                        imageUrl: info[key].imageUrl,
                        location: info[key].location
                    })
                })
                products.forEach(element => {
                    likeProductsArr.forEach(item => {
                        if(element.imageUrl == item.imageUrl) {
                            element.like = true
                        } 
                    });
                });
                this.products = products
            } catch(e) {
                alert('Произошла ошибка' + e)
            }
        },
        async getLikeProducts() {
            try {
                const uid = await this.$store.dispatch('getUid')
                const info = (await firebase.database().ref(`/users/${uid}/likeProducts`).once('value')).val()
                const products = []
                Object.keys(info).forEach(key => {
                    products.push({
                        title: info[key].title,
                        price: info[key].price,
                        imageUrl: info[key].imageUrl,
                        location: info[key].location,
                        like: true
                    })
                })
                this.products = products
            } catch(e) {
                alert('Произошла ошибка')
            }
        },
        async likeProduct(title, price, image, location) {
            try {
                await this.$store.dispatch('likeProducts', {
                    title: title,
                    price: price,
                    imageUrl: image,
                    location: location
                })
                this.getProducts()
            } catch(e) {
                alert('Произошла ошибка')
            }
        },
        setSearcher(title, location) {
            this.searchTitle = title
            this.searchLocation = location
        },
        setFilter(priceFrom, priceTo) {
            this.filterPriceFrom = priceFrom
            this.filterPriceTo = priceTo
        }
    },
    computed: {
        searchingProduct() {
            return this.products.filter((product) => {
                if(this.searchTitle != '' && this.searchLocation != '') {
                    return product.title.indexOf(this.searchTitle) > -1
                    && product.location.indexOf(this.searchLocation) > -1
                    && +product.price < +this.filterPriceTo
                    && +product.price > +this.filterPriceFrom
                } else if(this.searchTitle != '') {
                    return product.title.indexOf(this.searchTitle) > -1
                    && +product.price < +this.filterPriceTo
                    && +product.price > +this.filterPriceFrom
                }  else {
                    return product
                }
            })
        }
    }
}
</script>

<style lang="scss" scoped>
    .product-list {
        margin-bottom: 92px;
    }
    .product-list__box {
        display: flex;
        flex-wrap: wrap;
        max-width: 855px;
        margin: 0 auto;
    }
    .product-list__box--item {
        width: 209px;
        background: #fff;
        box-shadow: 0px 4px 14px rgba(121, 121, 121, 0.0527344);
        border-radius: 4px;
        border: 1px solid #E4E4E4;
        position: relative;
        margin: 10px 6px 0 0;
        &:nth-child(4n) {
            margin-right: 0;
        }
    }
    .product-list__box--item-img {
        display: block;
        border-radius: 4px 4px 0px 0px;
        padding: 2px 2.5px 0;
        width: 206px;
        height: 148px;
        margin: 0 auto;
    }
    .product-list__box--item-like {
        position: absolute;
        background: #fff;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.163407);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        top: 133px;
        left: 164px;
    }
    .product-list__box--item-title {
        color: #373738;
        font-size: 15px;
        font-weight: 400;
        padding: 6px 12px 0;
    }
    .product-list__box--item-price {
        color: #101010;
        font-size: 18px;
        font-weight: 700;
        padding: 7px 12px 10px;
    }
    .heart-svg {
        margin-top: 7px;
        margin-left: 5px;
        cursor: pointer;
    }
    .heart-svg__path {
        fill: #B7B7B7;
    }
    .like {
        fill: #349A89;
        background: #349A89;
    }
    @media screen and (max-width: 874px) {
        .product-list__box {
            max-width: 650px;
        }
    }
    @media screen and (max-width: 665px) {
        .product-list__box {
            max-width: 430px;
        }
    }
    @media screen and (max-width: 438px) {

        .product-list__box {
            justify-content: center;
        }
    }
</style>